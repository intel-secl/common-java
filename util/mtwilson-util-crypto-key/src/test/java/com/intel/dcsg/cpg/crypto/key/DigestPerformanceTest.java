/*
 * Copyright (C) 2019 Intel Corporation
 * SPDX-License-Identifier: BSD-3-Clause
 */
package com.intel.dcsg.cpg.crypto.key;

import java.security.MessageDigest;
import org.junit.BeforeClass;
import org.junit.Test;

/**
 * Compares time to re-use existing cipher instance vs using getInstance every time
 * @author jbuhacoff
 */
public class DigestPerformanceTest {
    private static final org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(DigestPerformanceTest.class);
    private final int max = 1000000;
    private static RandomSource random;
    private static byte[] plaintext;
    
    @BeforeClass
    public static void createKey() throws Exception {
        random = new RandomSource();
        plaintext = random.nextBytes(256); // arbitrary
    }
    
    /**
     * at 1,000 iterations,  we get testDigestNew 40 ms
     * at 10,000 iterations we get testDigestNew 165 ms
     * at 100,000 iterations we got testDigestNew 544 ms
     * at 1,000,000 iterations we got testDigestNew 3388 ms
     * @throws Exception 
     */
    @Test
    public void testDigestNew() throws Exception {
        long start = System.currentTimeMillis();
        for(int i=0; i<max; i++) {
            MessageDigest md = MessageDigest.getInstance("SHA-256");
            byte[] digest = md.digest(plaintext);
        }
        long stop = System.currentTimeMillis();
        log.debug("testDigestNew {} ms", stop-start);
    }
    
    /***
     * at 1,000 iterations we get testDigestCache 14 ms     65% faster
     * at 10,000 iterations we get testDigestCache 50 ms    70% faster
     * at 100,000 iterations we got testDigestCache 301 ms  45% faster 
     * at 1,000,000 iterations we got testDigestCache 2917 ms  15% faster
     * 
     * @throws Exception 
     */
    @Test
    public void testDigestCache() throws Exception {
        MessageDigest md = MessageDigest.getInstance("SHA-256");
        long start = System.currentTimeMillis();
        for(int i=0; i<max; i++) {
            byte[] digest = md.digest(plaintext);
        }
        long stop = System.currentTimeMillis();
        log.debug("testDigestCache {} ms", stop-start);
    }
    
}
